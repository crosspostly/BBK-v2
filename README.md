# Telegram Бот для бронирования слотов в Google Таблицах

## Описание Проекта

Этот Telegram-бот предназначен для автоматизации процесса бронирования свободных слотов (окошек) в Google Таблицах. Он позволяет пользователям Telegram просматривать доступные даты и записываться на них, а также собирать дополнительную информацию после записи. Бот разработан с использованием фреймворка `aiogram` и работает по принципу вебхуков, что делает его идеальным для развертывания на облачных платформах, таких как Google Cloud.

## Функционал

*   **Приветствие пользователя:** Команда `/start` выводит приветственное сообщение и кнопку для поиска свободных дат.
*   **Поиск свободных дат:** При нажатии кнопки "Показать свободные даты" (или команде `/available_dates`) бот обращается к указанной Google Таблице, находит даты, где есть пустые слоты для "Блогеров", и предлагает их пользователю.
*   **Бронирование слота:** Пользователь может выбрать дату из предложенного списка. Бот записывает Telegram `username` и `ID` пользователя в первую свободную ячейку для "Блогера" в выбранной дате.
*   **Защита от перезаписи:** Гарантирует, что существующие записи не будут перезаписаны.
*   **Работа через вебхуки:** Оптимизирован для работы в облачной среде, не требуя постоянного long-polling соединения.

## Используемые Технологии

*   **Python:** Язык программирования.
*   **aiogram:** Асинхронный фреймворк для разработки Telegram ботов.
*   **aiohttp:** Веб-фреймворк для создания веб-сервера, принимающего вебхуки.
*   **gspread:** Библиотека для взаимодействия с Google Sheets API.
*   **oauth2client:** Для аутентификации с Google Sheets API через сервисный аккаунт.

## Установка и Запуск

### 1. Предварительные требования

*   **Python 3.9+**
*   **Сервер Google Cloud (или любой другой, доступный из интернета)**
*   **Действующий аккаунт Telegram**
*   **Google Таблица с расписанием** (например, "Панда Ролс", лист "Расписание", с колонкой "Дата" и несколькими колонками "Блогер")

### 2. Настройка Google Sheets API

Для взаимодействия бота с Google Таблицами вам потребуется сервисный аккаунт Google Cloud:

1.  Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
2.  Создайте новый проект или выберите существующий.
3.  Перейдите в **APIs & Services -> Library** (API и Сервисы -> Библиотека) и включите:
    *   `Google Sheets API`
    *   `Google Drive API`
4.  Перейдите в **APIs & Services -> Credentials** (API и Сервисы -> Учетные данные).
5.  Нажмите **"Create Credentials" -> "Service Account"** (Создать учетные данные -> Сервисный аккаунт).
6.  Придумайте имя для сервисного аккаунта (например, `telegram-sheets-bot`), предоставьте ему роль **"Editor"** (или более гранулированную, если знаете какую) и нажмите "Done".
7.  После создания сервисного аккаунта, перейдите на вкладку **"Keys"** (Ключи) для этого аккаунта.
8.  Нажмите **"Add Key" -> "Create new key"**, выберите **JSON** и нажмите "Create". JSON-файл с учетными данными будет скачан на ваш компьютер.
9.  **Переименуйте скачанный файл в `credentials.json`** и загрузите его на ваш сервер в ту же директорию, где будет находиться файл бота.
10. **Поделитесь вашей Google Таблицей** с email-адресом сервисного аккаунта (он указан в файле `credentials.json` в поле `client_email`). Предоставьте ему право на **редактирование**.

### 3. Настройка Telegram Бота (BotFather)

1.  В Telegram найдите @BotFather.
2.  Создайте нового бота с помощью команды `/newbot`.
3.  Получите **токен вашего бота**. Он понадобится для файла `aiogram_webhook_bot.py`.

### 4. Генерация SSL-сертификата (для HTTPS)

Вебхуки Telegram требуют HTTPS. Вам понадобится SSL-сертификат для вашего домена/IP-адреса.

*   **Рекомендуется:** Использовать сертификат от Let's Encrypt или другого удостоверяющего центра.
*   **Для тестирования (не для продакшена):** Можно сгенерировать самоподписанный сертификат. Выполните на сервере:
    ```bash
    openssl req -newkey rsa:2048 -nodes -keyout webhook_pkey.pem -x509 -days 365 -out webhook_cert.pem
    ```
    Это создаст `webhook_pkey.pem` (приватный ключ) и `webhook_cert.pem` (сертификат). Разместите их в директории с ботом.

### 5. Правила фаервола Google Cloud

Вам нужно открыть входящий порт для вебхуков:

1.  **Разрешите входящий (Ingress) TCP-трафик на порт 8443** (или тот, который вы используете для `WEBAPP_PORT`) для вашей VM-инстанции. Источником должен быть `0.0.0.0/0`.
    *   Вы можете сделать это через Google Cloud Console или с помощью команды `gcloud` (замените `ВАШ_ID_ПРОЕКТА` и, при необходимости, `--target-tags`):
        ```bash
        gcloud compute firewall-rules create allow-telegram-webhook \
            --project=ВАШ_ID_ПРОЕКТА \
            --network=default \
            --action=ALLOW \
            --direction=INGRESS \
            --priority=1000 \
            --source-ranges=0.0.0.0/0 \
            --rules=tcp:8443 \
            --target-tags=ВАШ_ТЭГ_VM # Если ваша VM использует теги
        ```

### 6. Установка зависимостей

На вашем сервере, в директории проекта, выполните:

```bash
python3 -m venv venv
source venv/bin/activate
pip install aiogram aiohttp gspread
```

### 7. Конфигурация файла `aiogram_webhook_bot.py`

Откройте файл `aiogram_webhook_bot.py` и отредактируйте следующие строки в разделе `--- Configuration ---`:

*   `TOKEN`: Замените на токен вашего Telegram-бота.
*   `WEBHOOK_HOST`: Замените `YOUR_PUBLIC_IP_OR_DOMAIN` на публичный IP-адрес вашей VM или ваше доменное имя.
*   `WEBAPP_PORT`: Убедитесь, что это порт, который вы открыли в фаерволе (по умолчанию `8443`).
*   `WEBHOOK_SSL_CERT` и `WEBHOOK_SSL_PKEY`: Укажите правильные пути к вашим файлам сертификата и приватного ключа.

### 8. Запуск Бота

После выполнения всех вышеуказанных шагов, запустите бота на вашем сервере:

```bash
source venv/bin/activate
python aiogram_webhook_bot.py
```

Бот запустит веб-сервер и попытается установить вебхук в Telegram. В логах вы должны увидеть сообщение о том, что вебхук установлен.

Проверьте логи `aiogram_bot.log` на наличие ошибок.

## Дальнейшее Развитие

*   **Поддержка нескольких организаций:** Реализовать механизм для обработки нескольких Google Таблиц и настроек для разных организаций.
*   **Расширение функционала:** Добавление новых команд, типов бронирования, уведомлений и т.д.
*   **Улучшенная обработка ошибок:** Более детальные сообщения об ошибках для пользователя.

## Устранение Проблем

*   **Бот не отвечает:**
    *   Проверьте логи `aiogram_bot.log` на наличие ошибок.
    *   Убедитесь, что веб-сервер бота запущен и доступен по указанному `WEBHOOK_URL` (попробуйте открыть его в браузере, ожидается ошибка 405 Method Not Allowed, но не Connection Refused).
    *   Проверьте правила фаервола Google Cloud на входящий порт (п. 5).
    *   Убедитесь, что вебхук успешно установлен (проверьте логи бота и `/getWebhookInfo` через Bot API).
    *   Проверьте SSL-сертификат.
*   **Проблемы с Google Sheets:**
    *   Убедитесь, что `credentials.json` находится в той же директории и содержит правильные учетные данные.
    *   Проверьте, что email сервисного аккаунта добавлен как редактор в вашей Google Таблице.
    *   Убедитесь, что название таблицы ("Панда Ролс") и листа ("Расписание") в коде соответствуют реальным.
*   **Ошибка "Operation not permitted" при `pip install`:**
    *   Убедитесь, что вы активировали виртуальное окружение (`source venv/bin/activate`).
*   **BotFather не показывает информацию о вебхуке:**
    *   Убедитесь, что `set_webhook` в `on_startup` не выдает ошибок.

---
