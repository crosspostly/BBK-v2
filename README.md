# Telegram Бот для бронирования слотов в Google Таблицах

## Описание Проекта

Этот Telegram-бот предназначен для автоматизации процесса бронирования свободных слотов (окошек) в Google Таблицах. Он позволяет пользователям Telegram просматривать доступные даты и записываться на них, а также собирать дополнительную информацию после записи. Бот разработан с использованием фреймворка `aiogram` и работает по принципу вебхуков, что делает его идеальным для развертывания на облачных платформах, таких как Google Cloud.

## Функционал

*   **Приветствие пользователя:** Команда `/start` выводит приветственное сообщение и кнопку для поиска свободных дат.
*   **Поиск свободных дат:** При нажатии кнопки "Показать свободные даты" (или команде `/available_dates`) бот обращается к указанной Google Таблице, находит **актуальные** даты (сегодняшние и будущие), где есть пустые слоты для "Блогеров", и предлагает их пользователю. **Прошедшие даты автоматически скрываются.**
*   **Бронирование слота:** Пользователь может выбрать дату из предложенного списка. Бот показывает статус "печатает...", пока обрабатывает запрос, и записывает Telegram `username` и `ID` пользователя в первую свободную ячейку для "Блогера" в выбранной дате.
*   **Защита от перезаписи:** Гарантирует, что существующие записи не будут перезаписаны.
*   **Работа через вебхуки:** Оптимизирован для работы в облачной среде, не требуя постоянного long-polling соединения.

## Используемые Технологии

*   **Python:** Язык программирования.
*   **aiogram:** Асинхронный фреймворк для разработки Telegram ботов.
*   **aiohttp:** Веб-фреймворк для создания веб-сервера, принимающего вебхуки.
*   **gspread:** Библиотека для взаимодействия с Google Sheets API.
*   **oauth2client:** Для аутентификации с Google Sheets API через сервисный аккаунт.

## Структура Проекта

Проект включает в себя не только бота, но и мини-приложения (miniapps).
*   `bbk_miniapps/bot/`: Исходный код бота.
*   `bbk_miniapps/frontend/`: Фронтенд мини-приложения (Next.js).
*   `bbk_miniapps/backend/`: Бэкенд (FastAPI).

## Установка и Запуск

### 1. Предварительные требования

*   **Python 3.9+**
*   **Сервер Google Cloud (или любой другой, доступный из интернета)**
*   **Действующий аккаунт Telegram**
*   **Google Таблица с расписанием** (лист "Расписание", с колонкой "Дата" и несколькими колонками "Блогер")

### 2. Настройка Google Sheets API

Для взаимодействия бота с Google Таблицами вам потребуется сервисный аккаунт Google Cloud:

1.  Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
2.  Создайте новый проект или выберите существующий.
3.  Перейдите в **APIs & Services -> Library** (API и Сервисы -> Библиотека) и включите:
    *   `Google Sheets API`
    *   `Google Drive API`
4.  Перейдите в **APIs & Services -> Credentials** (API и Сервисы -> Учетные данные).
5.  Нажмите **"Create Credentials" -> "Service Account"** (Создать учетные данные -> Сервисный аккаунт).
6.  Придумайте имя для сервисного аккаунта (например, `telegram-sheets-bot`), предоставьте ему роль **"Editor"** (или более гранулированную, если знаете какую) и нажмите "Done".
7.  После создания сервисного аккаунта, перейдите на вкладку **"Keys"** (Ключи) для этого аккаунта.
8.  Нажмите **"Add Key" -> "Create new key"**, выберите **JSON** и нажмите "Create". JSON-файл с учетными данными будет скачан на ваш компьютер.
9.  **Переименуйте скачанный файл в `credentials.json`** и загрузите его на ваш сервер в директорию бота (`bbk_miniapps/bot/`).
10. **Поделитесь вашей Google Таблицей** с email-адресом сервисного аккаунта (он указан в файле `credentials.json` в поле `client_email`). Предоставьте ему право на **редактирование**.

### 3. Настройка Telegram Бота (BotFather)

1.  В Telegram найдите @BotFather.
2.  Создайте нового бота с помощью команды `/newbot`.
3.  Получите **токен вашего бота**. Он понадобится для файла `aiogram_webhook_bot.py`.

### 4. Генерация SSL-сертификата (для HTTPS)

Вебхуки Telegram требуют HTTPS. Вам понадобится SSL-сертификат для вашего домена/IP-адреса.

*   **Рекомендуется:** Использовать сертификат от Let's Encrypt или другого удостоверяющего центра.
*   **Для тестирования (не для продакшена):** Можно сгенерировать самоподписанный сертификат.

### 5. Правила фаервола

Вам нужно открыть входящий порт для вебхуков (по умолчанию 8443).

### 6. Установка зависимостей

На вашем сервере, в директории проекта, выполните:

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r bbk_miniapps/bot/requirements.txt # Если есть, или установите вручную
pip install aiogram aiohttp gspread oauth2client apscheduler pytz
```

### 7. Конфигурация файла `aiogram_webhook_bot.py`

Откройте файл `bbk_miniapps/bot/aiogram_webhook_bot.py` и отредактируйте следующие строки в разделе `--- Configuration ---`:

*   `TOKEN`: Замените на токен вашего Telegram-бота.
*   `SPREADSHEET_ID`: ID вашей Google Таблицы (находится в URL таблицы между `/d/` и `/edit`).
*   `WEBHOOK_HOST`: Замените `YOUR_PUBLIC_IP_OR_DOMAIN` на публичный IP-адрес вашей VM или ваше доменное имя.
*   `WEBAPP_PORT`: Убедитесь, что это порт, который вы открыли в фаерволе (по умолчанию `8443`).
*   `WEBHOOK_SSL_CERT` и `WEBHOOK_SSL_PKEY`: Укажите правильные пути к вашим файлам сертификата и приватного ключа.

### 8. Запуск Бота (Systemd Service)

Для надежной работы в продакшене рекомендуется использовать `systemd`.

Служба настроена как `bbk-bot.service`.

Управление службой:
```bash
sudo systemctl start bbk-bot.service   # Запуск
sudo systemctl stop bbk-bot.service    # Остановка
sudo systemctl restart bbk-bot.service # Перезапуск
sudo systemctl status bbk-bot.service  # Проверка статуса
```

**Важно:** Убедитесь, что запущена только одна копия бота. Если вы запускаете бота вручную (`python3 aiogram_webhook_bot.py`) при работающей службе, возникнет конфликт (`TelegramConflictError`), и бот будет работать некорректно.

## Устранение Проблем

*   **TelegramConflictError:** Означает, что запущено несколько экземпляров бота с одним токеном. Остановите все процессы Python, связанные с ботом, и запустите только службу `bbk-bot.service`.
*   **Ошибка подключения к таблице:** Проверьте `SPREADSHEET_ID` и права доступа сервисного аккаунта к таблице. Бот подключается по ID, а не по имени.

---
